name: K6 Load Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of load test to run'
        required: true
        default: 'performance'
        type: choice
        options:
          - performance
          - stress

permissions:
  contents: write

jobs:
  k6-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build tests
        run: npm run build:tests

      - name: Setup K6
        uses: grafana/setup-k6-action@v1

      - name: Restore history from gh-pages
        run: |
          git fetch origin gh-pages:gh-pages || echo "No gh-pages branch found"
          mkdir -p dashboard/public/data
          git show gh-pages:data/history.json > dashboard/public/data/history.json || echo "No history.json found"

      - name: Debug - List dist files
        run: ls -R dist

      - name: Run K6 ${{ github.event.inputs.test_type }} test
        run: |
          if [ "${{ github.event.inputs.test_type }}" = "stress" ]; then
            k6 run dist/tests/stress.js --summary-export=summary.json
          else
            k6 run dist/tests/performance.js --summary-export=summary.json
          fi

      - name: Process test results for dashboard
        run: npm run process-data

      - name: Build Dashboard
        run: npm run build:dashboard

      - name: Upload test results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-results-${{ github.event.inputs.test_type }}-${{ github.run_number }}
          path: |
            dist/tests/*-data.json
            summary.json
            dashboard/public/data/history.json
          retention-days: 30

      - name: Deploy Dashboard to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist/dashboard
          keep_files: true

      - name: Display test summary
        if: always()
        run: |
          echo "## K6 Load Test Results - ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Dashboard:** https://yota18.github.io/k6-petstore-load-test/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f summary.json ]; then
            echo "### Metrics Summary" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat summary.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No summary file generated" >> $GITHUB_STEP_SUMMARY
          fi
